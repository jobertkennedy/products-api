<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <title>Products API</title>
</head>
<body>
    <div class="container">
        <h1>Products API</h1>
        <div class="jumbotron">
            <h3><strong>Funciona!</strong></h3>
            <form action="/" method="get" id="form">
                <input 
                type="text" 
                name="" 
                id="productId" 
                placeholder="Insert a product id or leave it blank to get all"><br>
                <button id='formBtn'>Find</button>
            </form>
            <code id='res'></code>
        </div>
    </div>
    <script>
        const button = document.querySelector('button#formBtn')
        const productId = document.querySelector('input#productId')
        const resArea = document.querySelector('code#res')
        const form = document.querySelector('form#form')


        const responseModel = (response) => {
            const { title, desc, url } = response
            let text = `<h2><strong>${title}</strong></h2>\n<b>Descrição:</b> ${desc} \n<b>URL:</b> <a href="${url}" target="_blank">${url}</a>`
            return text
        }

        const callApi = async (id = undefined) => {
            resArea.innerHTML = ''
            let index = ""
            if(id != undefined){
                await fetch(`/api/products/${id}`)
                .then(res => {
                    res.json()
                })
                .then(res => {
                    console.log(res)
                    for(value in res){
                        if(res[value]['_id'] == id){
                            index = value
                            break
                        }
                    }
                    resArea.innerHTML = responseModel(res[index] || res[0])
                })
            } else {
                await fetch(`/api/products/`)
                .then(res => res.json())
                .then(res => {
                    for(value in res){
                        if(resArea.length == 0){
                            resArea.innerHTML = `${responseModel(res[value] || res[0])}\n\n`
                        } else {
                            resArea.innerHTML += `${responseModel(res[value] || res[0])}\n\n`
                        }
                    }
                })
            }
        }
        // alert('funciona')
        button.addEventListener('click', () => callApi(productId.value))
        form.addEventListener('submit', event => event.preventDefault())
    </script>
</body>
</html>